---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import BlogPost from '../components/BlogPost.astro';
import { join } from 'node:path';
import { getFileDate } from '../utils/date';
import { slugToTitle } from '../utils/format';

export async function getStaticPaths() {
  const pages = await getCollection('pages');
  return pages.map((page) => ({
    params: { slug: page.id.replace('.md', '') },
    props: { page }
  }));
}

const { page } = Astro.props;
const { Content } = await page.render();

// Only fetch posts if we're on the writing page
let posts = [];
if (page.id === 'writing.md') {
  const allPosts = await getCollection('writing');
  const buildTime = Date.now();
  
  // Get file creation dates and use them for sorting
  posts = await Promise.all(
    allPosts.map(async (post) => {
      // Get file creation date using utility function
      const filePath = join(process.cwd(), 'src', 'content', 'writing', post.id);
      const fileDate = await getFileDate(filePath);
      
      // If pubDate exists and is not from this build (default), use it
      // Otherwise use file creation date
      if (post.data.pubDate && fileDate.getTime() > 0) {
        const pubDateTime = post.data.pubDate.getTime();
        // If pubDate is within 2 seconds of build time, it's likely the default
        if (Math.abs(buildTime - pubDateTime) > 2000) {
          // pubDate was explicitly set, use it
          return { ...post, displayDate: post.data.pubDate, sortDate: post.data.pubDate };
        }
        // pubDate is default, use file date
        return { ...post, displayDate: fileDate, sortDate: fileDate };
      }
      
      // Use file date if available, otherwise pubDate, otherwise epoch
      const displayDate = fileDate.getTime() > 0 ? fileDate : (post.data.pubDate || new Date(0));
      return { ...post, displayDate, sortDate: displayDate };
    })
  );
  
  // Sort by creation date, newest first
  posts.sort((a, b) => {
    const dateA = a.sortDate.getTime();
    const dateB = b.sortDate.getTime();
    return dateB - dateA;
  });
}
---

<Layout title={page.data.title}>
  <Content />
  {posts.length > 0 && (
    <div class="posts">
      {posts.map((post) => (
        <BlogPost
          title={slugToTitle(post.slug)}
          url={`/writing/${post.slug}`}
          pubDate={post.displayDate}
          description={post.data.description}
        />
      ))}
    </div>
  )}
</Layout>