---
import Layout from '../../layouts/Layout.astro';
import { readdir, readFile } from 'node:fs/promises';
import { join } from 'node:path';
import { getFileDate } from '../../utils/date';
import { formatToolTitle } from '../../utils/format';

// Tool title overrides for special cases
const toolTitleOverrides: Record<string, string> = {
  'sqlite-csv-playground': 'SQLite CSV Playground Pro',
};

// Get all HTML files from public/tools
const toolsPath = join(process.cwd(), 'public', 'tools');
let tools = [];

try {
  const files = await readdir(toolsPath);
  const htmlFiles = files.filter(f => f.endsWith('.html') && !f.startsWith('_'));

  tools = await Promise.all(
    htmlFiles.map(async (file) => {
      const name = file.replace('.html', '');
      const mdFile = file.replace('.html', '.md');
      const filePath = join(toolsPath, file);

      // Try to read description from .md file
      let description = '';
      try {
        const mdPath = join(toolsPath, mdFile);
        description = await readFile(mdPath, 'utf-8');
        description = description.trim();
      } catch {
        // No description file, that's ok
      }

      // Get file creation date using utility function
      const createdDate = await getFileDate(filePath);
      
      // Format title using utility function with overrides
      const title = formatToolTitle(name, toolTitleOverrides);
      
      return {
        name,
        title,
        url: `/tools/${file}`,
        description,
        createdDate
      };
    })
  );

  // Sort by creation date, newest first
  tools.sort((a, b) => {
    const dateA = a.createdDate instanceof Date ? a.createdDate.getTime() : 0;
    const dateB = b.createdDate instanceof Date ? b.createdDate.getTime() : 0;
    // Newest first (larger timestamp - smaller timestamp)
    // If dates are equal, maintain original order
    if (dateB === dateA) return 0;
    return dateB - dateA;
  });
} catch (error) {
  console.error('Error reading tools:', error);
}
---

<Layout title="Tools">
  <h1>Tools</h1>

  <input
    type="search"
    id="search"
    placeholder="Search tools..."
    style="width: 100%; padding: 0.5rem; margin-bottom: 2rem; font-family: 'Times New Roman', Times, serif; font-size: 1rem; border: 1px solid #ddd; border-radius: 4px;"
  />

  {tools.length === 0 ? (
    <p>No tools yet. Add HTML files to <code>public/tools/</code> to get started.</p>
  ) : (
    <ul class="tools-list" id="tools-list">
      {tools.map(tool => (
        <li class="tool-item" data-title={tool.title.toLowerCase()} data-description={tool.description?.toLowerCase() || ''}>
          <a href={tool.url}>{tool.title}</a>
          {tool.description && <span class="description"> â€” {tool.description}</span>}
          <a href={`https://github.com/rynf1t/site/blob/main/public/tools/${tool.name}.html`} class="github-link" target="_blank" rel="noopener noreferrer">[see code]</a>
        </li>
      ))}
    </ul>
  )}

  <script>
    const search = document.getElementById('search') as HTMLInputElement | null;
    const toolsList = document.getElementById('tools-list');
    const items = toolsList?.querySelectorAll('.tool-item') as NodeListOf<HTMLElement> | undefined;

    search?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase();
      items?.forEach(item => {
        const title = item.dataset.title || '';
        const description = item.dataset.description || '';
        const matches = title.includes(query) || description.includes(query);
        item.style.display = matches ? '' : 'none';
      });
    });
  </script>
</Layout>

<style>
  .tools-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .tool-item {
    margin-bottom: 0.75rem;
    line-height: 1.6;
  }

  .tool-item a {
    color: #0066cc;
    text-decoration: none;
    font-weight: bold;
  }

  .tool-item a:hover {
    text-decoration: underline;
  }

  .description {
    color: #666;
  }

  .tool-item .github-link {
    color: #0066cc !important;
    text-decoration: none;
    font-size: 0.9em;
    margin-left: 0.5rem;
  }

  .tool-item .github-link:hover {
    text-decoration: underline;
  }
</style>
